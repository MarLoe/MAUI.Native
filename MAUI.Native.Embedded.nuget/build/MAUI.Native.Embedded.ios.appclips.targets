<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <ProcessAppClipsDependsOn>
      _InitXcodeProjects;
      _ResolveAppClips;
      _UpdateXcodeProjectVersion;
      _BuildAppClips;
    </ProcessAppClipsDependsOn>
  </PropertyGroup>


  <Target Name="_ResolveAppClips" Condition="'@(AppClips)' != ''">
    <Error Condition="Exists('%(AppClips.FullPath)') == 'false'" Code="404" Text="AppClips project not found: '%(AppClips.Identity)'" />

    <ItemGroup>
      <AppClips>
        <Scheme Condition="'%(AppClips.Scheme)' == ''">%(AppClips.Filename)</Scheme>
        <Configuration Condition="'%(AppClips.Configuration)' == ''">$(Configuration)</Configuration>
        <UnsignedName></UnsignedName>
      </AppClips>
      <AppClips Condition="'%(AppClips.NoSigning)' == 'true'">
        <UnsignedName>-unsigned</UnsignedName>
        <XcodeParams>$(XcodeParams) CODE_SIGN_IDENTITY=”” CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO</XcodeParams>
      </AppClips>
      <!-- We cannot add the ArchivePath in one go, so we have to do it separately once we have Scheme and Configuration metadata -->
      <AppClips>
        <ArchivePath>$(_XcodeArchivePath)/%(AppClips.Scheme)-%(AppClips.Configuration)%(AppClips.UnsignedName).xcarchive</ArchivePath>
      </AppClips>

      <!-- Consolidate all included Xcode projects -->
      <XcodeProjects Include="%(AppClips.FullPath)" />
    </ItemGroup>
  </Target>


  <Target Name="_BuildAppClips" Condition="'@(AppClips)' != ''">
    <PropertyGroup>
      <_XcodeDestination Condition="$(TargetPlatformIdentifier) == 'ios'">iOS</_XcodeDestination>
      <_XcodeDestination Condition="$(RuntimeIdentifier.Contains('iossimulator')) == true">iOS Simulator</_XcodeDestination>
    </PropertyGroup>
    <Exec
      Command="xcrun xcodebuild archive -project '%(AppClips.FullPath)' -scheme '%(AppClips.Scheme)' -configuration '%(AppClips.Configuration)' -destination 'generic/platform=$(_XcodeDestination)' -archivePath '%(AppClips.ArchivePath)' %(AppClips.XcodeParams)"
      Outputs="%(AppClips.ArchivePath)" />
  </Target>


  <Target Name="ProcessAppClips" BeforeTargets="ProcessMauiAssets" DependsOnTargets="$(ProcessAppClipsDependsOn)" Condition="'$(TargetPlatformIdentifier)' == 'ios' AND '@(AppClips)' != ''">
    <ItemGroup>
      <_AppClipsFiles Include="%(AppClips.ArchivePath)/**/*.app/AppClips/**" />

      <_AppClipsFiles>
        <TargetPath>$([System.Text.RegularExpressions.Regex]::Replace('%(_AppClipsFiles.FullPath)', '^.*[\\/]AppClips[\\/]', ''))</TargetPath>
      </_AppClipsFiles>

      <!-- Include the found AppClips in the MAUI app -->
      <MauiAsset Include="@(_AppClipsFiles)" LogicalName="AppClips/%(_AppClipsFiles.TargetPath)" />
    </ItemGroup>

    <Error Condition="'@(_AppClipsFiles)' == ''" Code="404" Text="No AppClips found in Xcode project: '%(AppClips.Identity)'" />
  </Target>


  <Target Name="VerifyAppClips" AfterTargets="Build" Condition="'$(TargetPlatformIdentifier)' == 'ios' AND '@(AppClips)' != ''">
    <ItemGroup>
      <_AppClipsMobileProvisioning Condition="'%(AppClips.SkipValidation)' != 'true'" Include="%(AppClips.ArchivePath)/**/AppClips/**/embedded.mobileprovision" />
    </ItemGroup>

    <Exec
      Condition="'@(_AppClipsMobileProvisioning)' != ''"
      Command="security cms -D -i '@(_AppClipsMobileProvisioning)' | sed -n '/&lt;key&gt;com.apple.developer.parent-application-identifiers&lt;\/key&gt;/,/&lt;\/array&gt;/p' | grep '$(ApplicationId)&lt;'"
      IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="ExitCode" />
    </Exec>

    <Error Condition="'$(ExitCode)' != '' AND '$(ExitCode)' != '0'" Code="1013" Text="AppClips application identifier does not mathc this 'ApplicationId': $(ApplicationId)" />
  </Target>

</Project>