<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <BuildNativeEmbedded>AppClips;Widgets</BuildNativeEmbedded>
  </PropertyGroup>


  <Target Name="_InitXcodeProjects">
    <PropertyGroup>
      <!-- Use the build system default output root, if it is available -->
      <XcodeOutputPathRoot Condition="'$(XcodeOutputPathRoot)' == ''">$(_XcodeProjectDefaultOutputPathRoot)</XcodeOutputPathRoot>
      <XcodeOutputPathRoot Condition="'$(XcodeOutputPathRoot)' == ''">$(MSBuildProjectDirectory)/$(IntermediateOutputPath)xcode/</XcodeOutputPathRoot>
      <XCodeCommonParams Condition="'$(XCodeCommonParams)' == ''">-derivedDataPath '$(XcodeOutputPathRoot)DerivedData' -packageCachePath '$(XcodeOutputPathRoot)Cache'</XCodeCommonParams>
    </PropertyGroup>
  </Target>


  <Target
    Name="_UpdateXcodeProjectVersion"
    Inputs="%(XcodeProjects.Identity)"
    Outputs="%(XcodeProjects.Identity)"
    Condition="'@(XcodeProjects)' != ''">
    <!-- The Xcode projects must have the same version as our app - so we must update it -->
    <Exec
      Condition="'$(ApplicationVersion)' != ''"
      Command="xcrun agvtool new-version -all '$(ApplicationVersion)'"
      WorkingDirectory="%(XcodeProjects.RootDir)%(XcodeProjects.Directory)" />

    <Exec
      Condition="'$(ApplicationDisplayVersion)' != ''"
      Command="xcrun agvtool new-marketing-version '$(ApplicationDisplayVersion)'"
      WorkingDirectory="%(XcodeProjects.RootDir)%(XcodeProjects.Directory)" />

    <!-- The agvtool new-marketing-version might not work if plist is auto generated -->
    <!-- So we will manually make sure it is updated -->
    <Exec
      Condition="'$(ApplicationDisplayVersion)' != ''"
      Command="sed -i '' 's/MARKETING_VERSION = .*/MARKETING_VERSION = $(ApplicationDisplayVersion);/g' '%(XcodeProjects.FullPath)/project.pbxproj'"
      WorkingDirectory="%(XcodeProjects.RootDir)%(XcodeProjects.Directory)" />
  </Target>


  <PropertyGroup>
    <_ResolveNativeEmbeddedDependsOn />

    <_ProcessNativeEmbeddedDependsOn>
      _InitXcodeProjects;
      _ResolveNativeEmbedded;
      _UpdateXcodeProjectVersion;
    </_ProcessNativeEmbeddedDependsOn>

    <_VerifyNativeEmbeddedDependsOn />
  </PropertyGroup>


  <Target Name="_ResolveNativeEmbedded" DependsOnTargets="$(_ResolveNativeEmbeddedDependsOn)" />


  <Target Name="ProcessNativeEmbedded" BeforeTargets="ProcessMauiAssets" DependsOnTargets="$(_ProcessNativeEmbeddedDependsOn)" />


  <Target Name="VerifyNativeEmbedded" AfterTargets="Build" DependsOnTargets="$(_VerifyNativeEmbeddedDependsOn)" />

</Project>