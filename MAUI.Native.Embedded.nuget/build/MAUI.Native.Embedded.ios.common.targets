<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="_InitXcodeProjects">
    <PropertyGroup>
      <!-- Use the build system default output root, if it is available -->
      <XcodeOutputPathRoot Condition="'$(XcodeOutputPathRoot)' == ''">$(_XcodeProjectDefaultOutputPathRoot)</XcodeOutputPathRoot>
      <XcodeOutputPathRoot Condition="'$(XcodeOutputPathRoot)' == ''">$(MSBuildProjectDirectory)/$(IntermediateOutputPath)xcode/</XcodeOutputPathRoot>
      <XCodeCommonParams Condition="'$(XCodeCommonParams)' == ''">-derivedDataPath '$(XcodeOutputPathRoot)DerivedData' -packageCachePath '$(XcodeOutputPathRoot)Cache'</XCodeCommonParams>
    </PropertyGroup>
  </Target>


  <Target
    Name="_UpdateXcodeProjectVersion"
    Inputs="%(XcodeProjects.Identity)"
    Outputs="%(XcodeProjects.Identity)"
    Condition="'@(XcodeProjects)' != ''">
    <!-- The Xcode projects must have the same version as our app - so we must update it. -->
    <!-- Do not use agvtool as it cannot work on indicidual projects. Roll our own :)     -->
    <Exec
      Condition="'$(ApplicationVersion)' != ''"
      Command="sed -i '' 's/CURRENT_PROJECT_VERSION = .*/CURRENT_PROJECT_VERSION = $(ApplicationVersion);/g' '%(XcodeProjects.FullPath)/project.pbxproj'"
      WorkingDirectory="%(XcodeProjects.RootDir)%(XcodeProjects.Directory)" />

    <Exec
      Condition="'$(ApplicationDisplayVersion)' != ''"
      Command="sed -i '' 's/MARKETING_VERSION = .*/MARKETING_VERSION = $(ApplicationDisplayVersion);/g' '%(XcodeProjects.FullPath)/project.pbxproj'"
      WorkingDirectory="%(XcodeProjects.RootDir)%(XcodeProjects.Directory)" />
  </Target>


  <PropertyGroup>
    <_InitNativeEmbeddedDependsOn />

    <_ResolveNativeEmbeddedDependsOn />

    <_ProcessNativeEmbeddedDependsOn>
      _InitXcodeProjects;
      _ResolveNativeEmbedded;
      _UpdateXcodeProjectVersion;
    </_ProcessNativeEmbeddedDependsOn>

    <ProcessNativeEmbeddedDependsOn>
      _InitNativeEmbedded;
      _ProcessNativeEmbedded;
    </ProcessNativeEmbeddedDependsOn>

    <VerifyNativeEmbeddedDependsOn />
  </PropertyGroup>

  <Target Name="_InitNativeEmbedded" DependsOnTargets="$(_InitNativeEmbeddedDependsOn)" />


  <Target Name="_ResolveNativeEmbedded" DependsOnTargets="$(_ResolveNativeEmbeddedDependsOn)" />


  <Target Name="_ProcessNativeEmbedded" DependsOnTargets="$(_ProcessNativeEmbeddedDependsOn)" />


  <Target Name="ProcessNativeEmbedded" BeforeTargets="ProcessMauiAssets" DependsOnTargets="$(ProcessNativeEmbeddedDependsOn)" />


  <Target Name="VerifyNativeEmbedded" AfterTargets="Build" DependsOnTargets="$(VerifyNativeEmbeddedDependsOn)" />

</Project>