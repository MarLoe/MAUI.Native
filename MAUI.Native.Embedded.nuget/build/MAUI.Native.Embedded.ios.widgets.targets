<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <BuildNativeEmbedded>$(BuildNativeEmbedded);Widgets</BuildNativeEmbedded>
    <_InitNativeEmbeddedDependsOn>
      $(_InitNativeEmbeddedDependsOn);
      _InitWidgets;
    </_InitNativeEmbeddedDependsOn>
  </PropertyGroup>


  <Target Name="_InitWidgets" Condition="'@(Widgets)' != ''">
    <PropertyGroup Condition="'$(TargetPlatformIdentifier)' == 'ios' AND $(BuildNativeEmbedded.Contains('Widgets'))">
      <_ResolveNativeEmbeddedDependsOn>
        $(_ResolveNativeEmbeddedDependsOn);
        _ResolveWidgets;
      </_ResolveNativeEmbeddedDependsOn>

      <_ProcessNativeEmbeddedDependsOn>
        $(_ProcessNativeEmbeddedDependsOn);
        ProcessWidgets;
      </_ProcessNativeEmbeddedDependsOn>

      <ProcessWidgetsDependsOn>
        $(ProcessWidgetsDependsOn);
      </ProcessWidgetsDependsOn>

      <VerifyNativeEmbeddedDependsOn>
        $(VerifyNativeEmbeddedDependsOn);
        VerifyWidgets;
      </VerifyNativeEmbeddedDependsOn>
    </PropertyGroup>
  </Target>


  <Target Name="_ResolveWidgets">
    <Error Condition="Exists('%(Widgets.FullPath)') == 'false'" Code="404" Text="Widgets project not found: '%(Widgets.Identity)'" />

    <ItemGroup>
      <Widgets>
        <!-- Mark this as a Widgets project so we can   -->
        <!-- identify it from XcodeProjects later on.   -->
        <IsWidgets>true</IsWidgets>
      </Widgets>

      <!-- Consolidate all included Xcode projects      -->
      <XcodeProjects Include="@(Widgets)" />
    </ItemGroup>
  </Target>


  <Target Name="ProcessWidgets" DependsOnTargets="$(ProcessWidgetsDependsOn)" Condition="'@(Widgets)' != ''">
    <ItemGroup>
      <Widgets Remove="@(Widgets)" />
      <Widgets Include="@(XcodeProjects)" Condition="'%(XcodeProjects.IsWidgets)' == 'true'" />
    </ItemGroup>

    <ItemGroup>
      <_AppexFiles Include="%(Widgets.ArchivePath)/**/*.app/PlugIns/**/*.appex/**" />
      <_AppexBundles Include="$([System.Text.RegularExpressions.Regex]::Replace('%(_AppexFiles.FullPath)', '(^.*\.appex)[\\/].*', '$1'))" />
    </ItemGroup>

    <!-- Make sure each .appex is actually a widget -->
    <Delete Condition="Exists('%(_AppexBundles.FullPath).widget')" Files="%(_AppexBundles.FullPath).widget" />

    <Exec Command="plutil -extract NSExtension xml1 -o - '%(_AppexBundles.FullPath)/Info.plist' | grep -q 'com.apple.widgetkit-extension' &amp;&amp; echo 'true' > '%(_AppexBundles.FullPath).widget'" IgnoreExitCode="true" />

    <ItemGroup>
      <AdditionalAppExtensions Include="%(_AppexBundles.FullPath)/.." Condition="Exists('%(_AppexBundles.FullPath).widget')">
        <Name>%(_AppexBundles.Filename)</Name>
      </AdditionalAppExtensions>
    </ItemGroup>
  </Target>


  <Target Name="VerifyWidgets" Condition="'@(Widgets)' != ''">
    <!-- TODO: Find a way to verify that Widgets was correctly included -->
  </Target>


  <!-- This target is for debug purposes. See README.md for information -->
  <Target Name="BuildWidgets">
    <PropertyGroup>
      <BuildNativeEmbedded>Widgets</BuildNativeEmbedded>
    </PropertyGroup>
    <CallTarget Targets="_InitWidgets;_ProcessNativeEmbedded" />
  </Target>

</Project>