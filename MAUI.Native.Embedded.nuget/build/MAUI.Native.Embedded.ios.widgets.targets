<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <ProcessWidgetsDependsOn>
      _ResolveWidgets;
      _UpdateXcodeProjectVersion;
      _BuildWidgets;
    </ProcessWidgetsDependsOn>
  </PropertyGroup>


  <Target Name="_ResolveWidgets" Condition="'@(Widgets)' != ''">
    <PropertyGroup>
      <WidgetsArchiveBase Condition="'$(WidgetsArchiveBase)' == ''">$(IntermediateOutputPath)</WidgetsArchiveBase>
      <WidgetsArchiveDir Condition="'$(WidgetsArchiveDir)' == ''">xcodebuild/</WidgetsArchiveDir>
      <!-- We will always overwrite _WidgetsArchivePath to avoid mismatch with WidgetsArchiveBase and WidgetsArchiveDir -->
      <_WidgetsArchivePath>$(WidgetsArchiveBase)$(WidgetsArchiveDir)</_WidgetsArchivePath>
    </PropertyGroup>

    <Error Condition="Exists('%(Widgets.FullPath)') == 'false'" Code="404" Text="Widgets project not found: '%(Widgets.Identity)'" />

    <ItemGroup>
      <Widgets>
        <Scheme Condition="'%(Widgets.Scheme)' == ''">%(Widgets.Filename)</Scheme>
        <Configuration Condition="'%(Widgets.Configuration)' == ''">$(Configuration)</Configuration>
        <UnsignedName></UnsignedName>
      </Widgets>
      <Widgets Condition="'%(Widgets.NoSigning)' == 'true'">
        <UnsignedName>-unsigned</UnsignedName>
        <XcodeParams>$(XcodeParams) CODE_SIGN_IDENTITY=”” CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO</XcodeParams>
      </Widgets>
      <!-- We cannot add the ArchivePath in one go, so we have to do it separately once we have Scheme and Configuration metadata -->
      <Widgets>
        <ArchivePath>$(_WidgetsArchivePath)/%(Widgets.Scheme)-%(Widgets.Configuration)%(Widgets.UnsignedName).xcarchive</ArchivePath>
      </Widgets>

      <!-- Consolidate all included Xcode projects -->
      <XcodeProjects Include="%(Widgets.FullPath)" />
    </ItemGroup>
  </Target>


  <Target Name="_BuildWidgets" Condition="'@(Widgets)' != ''">
    <Exec
      Command="xcrun xcodebuild archive -project '%(Widgets.FullPath)' -scheme '%(Widgets.Scheme)' -configuration '%(Widgets.Configuration)' -destination 'generic/platform=iOS' -archivePath '%(Widgets.ArchivePath)' %(Widgets.XcodeParams)"
      Outputs="%(Widgets.ArchivePath)" />
  </Target>


  <Target Name="ProcessWidgets" BeforeTargets="ProcessMauiAssets" DependsOnTargets="$(ProcessWidgetsDependsOn)" Condition="'$(TargetPlatformIdentifier)' == 'ios' AND '@(Widgets)' != ''">
    <ItemGroup>
      <_AppexFiles Include="%(Widgets.ArchivePath)/**/*.app/PlugIns/**/*.appex/**" />
      <_AppexBundles Include="$([System.Text.RegularExpressions.Regex]::Replace('%(_AppexFiles.FullPath)', '(^.*\.appex)[\\/].*', '$1'))" />
    </ItemGroup>

    <!-- Make sure each .appex is actually a widget -->
    <Exec Command="plutil -extract NSExtension xml1 -o - '%(_AppexBundles.FullPath)/Info.plist' | grep com.apple.widgetkit-extension &amp;&amp; echo 'true' > '%(_AppexBundles.FullPath).widget'" IgnoreExitCode="true" />

    <ItemGroup>
      <_WidgetsFiles Include="%(_AppexBundles.FullPath)/**" Condition="Exists('%(_AppexBundles.FullPath).widget')"/>
      <_WidgetsFiles>
        <TargetPath>$([System.Text.RegularExpressions.Regex]::Replace('%(_WidgetsFiles.FullPath)', '^.*[\\/]PlugIns[\\/]', ''))</TargetPath>
      </_WidgetsFiles>

      <!-- Include the found Widgets in the MAUI app -->
      <MauiAsset Include="@(_WidgetsFiles)" LogicalName="PlugIns/%(_WidgetsFiles.TargetPath)" />
    </ItemGroup>

    <Error Condition="'@(_WidgetsFiles)' == ''" Code="404" Text="No Widgets found in Xcode project: '%(Widgets.Identity)'" />
  </Target>


  <!--
  <Target Name="VerifyAppClips" AfterTargets="Build" Condition="'$(TargetPlatformIdentifier)' == 'ios' AND '@(AppClips)' != ''">
    <ItemGroup>
      <_AppClipsMobileProvisioning Condition="'%(AppClips.SkipValidation)' != 'true'" Include="%(AppClips.ArchivePath)/**/AppClips/**/embedded.mobileprovision" />
    </ItemGroup>

    <Exec
      Condition="'@(_AppClipsMobileProvisioning)' != ''"
      Command="security cms -D -i '@(_AppClipsMobileProvisioning)' | sed -n '/&lt;key&gt;com.apple.developer.parent-application-identifiers&lt;\/key&gt;/,/&lt;\/array&gt;/p' | grep '$(ApplicationId)&lt;'"
      IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="ExitCode" />
    </Exec>

    <Error Condition="'$(ExitCode)' != '' AND '$(ExitCode)' != '0'" Code="1013" Text="AppClips application identifier does not mathc this 'ApplicationId': $(ApplicationId)" />
  </Target>
  -->

</Project>